# massconf

Скрипт служит для массового применения списка команд из файла **commands.txt** на списке оборудования из файла **hosts.txt**. Выполняет в 10 потоков.
Скрипт автоматически понимает в каком режиме применять команды (**show** и **wr** - в привилегированном, остальные в режиме конфигурации). Есть отработка некоторых команд, которые могут ждать интерактива от пользователя (пока только **no username** и **copy**, если что, будем расширять)
Ведется подробный лог, что произошло в файл **messages.log**. Неудачные коннекты записываются в файл **failed.txt**

## Установка
- [ ] Создаем venv:
    `python3 -m venv .venv`
- [ ] Активируем его:
    `source .venv/bin/activate`
- [ ] Устанавливаем зависимости:
    `pip3 install -r requirements.txt`


## Настройка

- [ ] Переименовываем .example файлы
```
for f in *.example .example .*.example; do [ -e "$f" ] && \cp -f "$f" "${f%.example}"; done
```
- [ ] Заполняем учетные данные в файле `.env`
- [ ] Заполняем настройки ssh в файле `ssh_config` (Сделаны чаще всего встречаемые настройки, возможно не потребуется, но если что, менять тут)
- [ ] Заполняем файлы `hosts.txt` и `commands.txt`


## Запуск

```
.venv/bin/python3 main.py
```

# P.S.
Команду **show** не писать сокращенно, только полностью **show**, т.к. именно по этой команде скрипт понимает, что это команда привилегированного режима. А сократить не получится, т.к. тогда все, что будет начинаться на sh, будет выполняться в привилегированном режиме )

Есть возможность дебаггинга работы scrapli. Включается переменной **SCRAPLI_DEBUG**. Пишет полный вывод всех введенных и полученных символов, а также переменные и режимы работы в файл **scrapli_debug.log**.

## Возможность использования аналитики

Предусмотрен ручной режим анализа и реагирования по результатам. Организован в виде модульной структуры в папке **analyzer_modules** 

Модуль должен содержать функцию ***analyze(host: str, output: str) -> list[str]***, где **host** - имя хоста, на котором была запущена команда и **output** - результат команды.

На выходе из аналитики ожидается список команд, который необходимо применить на данном хосте. Он может быть пустой (возможно просто какое-то информирование внутри модуля)

В **settings.py** переменной **ANALYZER_MODULE** присваивается имя необходимого модуля. При пустой строке, модули не подгружаются и функционал анализатора не включается. 

В примере имеется модуль, который в выводе `show run` ищет строку `username test` и при ее наличии, отдает команду на ее удаление `no username test`   

